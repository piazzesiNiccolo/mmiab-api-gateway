<!doctype html>
<html lang="en">
    <head>
    <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <!-- Bootstrap Icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
        <title>mmiab</title>
        <!-- Bootstrap Bundle with Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

         <script>
             {% if calendar_view is not none %}
                 {% include "js/calendar.js" %}
                 window.addEventListener('load', function() { 
                     var container = document.getElementById("main-container");
                     populate_day_nav(container, {{calendar_view|tojson}}, '{{list_type}}'); 
                 });
             {% endif %}
         </script>

         <style>
            {% include "css/style.css" %} 
            {% include "css/mailbox_bs.css" %}
         </style>
         <!--<link rel="stylesheet" href="css/style.css">-->
         <!--<link rel="stylesheet" href="css/mailbox_bs.css">-->
         {% from 'alert_macro.html' import warning %}
         {% from 'alert_macro.html' import flash %}
         {% include 'notifications.html' %}
    </head>
    <body>
    {% include "navbar_bs.html" %}
    <div style="min-height: 80px;">
        <div class="container py-3 overflow-hidden" style="padding-bottom: 200px;">
            <div class="row justify-content-center mb-3">
                <div id="alert-box" class="col-10">
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                            {{ flash(message) }}
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                </div>
            </div>
        </div>
    </div>
    <div id="main-container" class="container overflow-hidden">
      {% if calendar_view is not none %}
      <div class="row py-2">
          <div class="col-3">
              <div class="px-0">
                  <button type="button" class="btn btn-primary bg-navy d-flex justify-content-center align-items-center py-2 month-button">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-calendar3" viewBox="0 0 16 16">
  <path d="M14 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM1 3.857C1 3.384 1.448 3 2 3h12c.552 0 1 .384 1 .857v10.286c0 .473-.448.857-1 .857H2c-.552 0-1-.384-1-.857V3.857z"/>
  <path d="M6.5 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
</svg>
                  </button>
              </div>
          </div>
          <div class="col-1">
              <div class="d-grid px-0">
                  <button type="button" class="btn btn-primary bg-navy d-flex justify-content-center align-items-center py-2 prev-button">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-left-circle-fill" viewBox="0 0 16 16">
  <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.5 7.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5z"/>
</svg>
                  </button>
              </div>
          </div>
          <div class="col">
              <div class="text-center text-navy fs-3 fw-bold date-desc">24/12/2021</div>
          </div>
          <div class="col-1">
              <div class="d-grid px-0">
                  <button type="button" class="btn btn-primary bg-navy d-flex justify-content-center align-items-center py-2 next-button">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-right-circle-fill" viewBox="0 0 16 16">
  <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0zM4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H4.5z"/>
</svg>
                  </button>
              </div>
          </div>
      </div>
      {% endif %}
      <div class="row justify-content-center mb-3">
          <div class="col-8">
              <div class="fw-bold fs-2 text-navy px-3">Mailbox</div>
          </div>
          <div class="col-3">
              {% if list_type == 'draft' %}
              <div class="hstack">
                  <button onclick="location.href='{{url_for('messages.draft')}}'" type="button" class="ms-auto mx-3 btn btn-primary btn-lg">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-send-plus-fill" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 1.59 2.498C8 14 8 13 8 12.5a4.5 4.5 0 0 1 5.026-4.47L15.964.686Zm-1.833 1.89.471-1.178-1.178.471L5.93 9.363l.338.215a.5.5 0 0 1 .154.154l.215.338 7.494-7.494ZM16 12.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Zm-3.5-2a.5.5 0 0 1 .5.5v1h1a.5.5 0 0 1 0 1h-1v1a.5.5 0 0 1-1 0v-1h-1a.5.5 0 0 1 0-1h1v-1a.5.5 0 0 1 .5-.5Z"/>
    </svg>
                  </button>
              </div>
              {% endif %}
          </div>
      </div>
      <div class="row py-2 justify-content-center">
          <div class="col-3">
              <ul class="nav nav-pills flex-column text-end fs-5 fw-bold">
                {% if calendar_view is none %}
                    {% set received_url = url_for('messages.list_received_messages') %}
                    {% set sent_url = url_for('messages.list_sent_messages') %}
                    {% set draft_url = url_for('messages.list_drafts') %}
                {% else %}
                    {% set sent_url = url_for('messages.list_sent_messages', y=calendar_view['today'][0], m=calendar_view['today'][1], d=calendar_view['today'][2]) %}
                    {% set received_url = url_for('messages.list_received_messages', y=calendar_view['today'][0], m=calendar_view['today'][1], d=calendar_view['today'][2]) %}
                {% endif %}
                  <li class="nav-item">
                      <a href="{{ received_url }}" class="nav-link {{'active' if list_type=='received'}}">Received</a>
                  </li>
                  <li class="nav-item">
                      <a href="{{ sent_url }}" class="nav-link {{'active' if list_type=='sent'}}">Sent</a>
                  </li>
                  {% if calendar_view is none %}
                  <li class="nav-item">
                      <a href="{{ draft_url }}" class="nav-link {{'active' if list_type=='draft'}}">Draft</a>
                  </li>
                  {% endif %}
              </ul>
          </div>
          <div class="col-8">
              {% if message_list|length == 0 %}
              <div class="hstack justify-content-center text-primary" style="opacity: 0.2; margin-top: 50px;">
                  {% if list_type == 'received' %}
                  <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" fill="currentColor" class="bi bi-envelope" viewBox="0 0 16 16">
                      <path fill-rule="evenodd" d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
                  </svg>
                  {% elif list_type == 'sent' %}
                  <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                      <path fill-rule="evenodd" d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                  </svg>
                  {% else %}
                  <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
                      <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                  </svg>
                  {% endif %}
              </div>
              {% endif %}
              <div class="container-fluid message-container">
              <!-- TODO: fix below -->
              {% for m in message_list: %}
                {% if list_type != 'received' %}
                    {% set message_url = url_for('messages.read_messages', id=m.id_message) %}
                    {% set message_body = m.message_body %}
                    {% set datetime_list = (m.delivery_date|delivery_datetime_format).split(' ') %}
                    {% set id_message = m.id_message %}
                {% else %}
                    {% set message_url = url_for('messages.read_messages', id=m.id_message) %}
                    {% set user_url = url_for('users.user_info', id=m.id_sender) %}
                    {% set first_name = senders[m.id_sender]['first_name'] if m.id_sender in senders else 'Anonymous' %}
                    {% set last_name = senders[m.id_sender]['last_name']  if m.id_sender in senders else ''%}
                    {% set message_body = m.message_body %}
                    {% set datetime_list = (m.delivery_date|delivery_datetime_format).split(' ') %}
                    {% set id_message = m.id_message %}
                {% endif %}
                  <div class="row bg-info mb-2 rounded-3 message-row" >
                      <div class="col-9">
                          <div class="hstack">
                              <div 
                                  class="rounded-circle {{'bg-primary' if opened_dict is defined and opened_dict[id_message] == False else 'bg-info'}}" 
                                  style="width: 12px; height: 12px; margin-right: 10px;"> 
                              </div>
                              <div class="container-fluid h-100 gx-0">
                                  <div class="row user-row justify-content-start align-items-end">
                                      <div class="col">
                                          <div class="hstack user-stack">
                                            {% if list_type != 'received' %}
                                                {% for recipient in m.recipients %}
                                                    {% set first_name = recipients[recipient]['first_name'] if recipient in recipients else 'Anonymous'%}
                                                    {% set last_name = recipients[recipient]['last_name'] if recipient in recipients else ''%}
                                                    {% set user_url = url_for('users.user_info', id=recipient) %}
                                                      <a href="{{ user_url }}">
                                                          <span class="badge rounded-pill bg-primary text-white fs-5 m-1 user">
                                                                  {{ 'RE: ' if m.reply_to is not none and loop.index0 == 0 }}
                                                                  {{ first_name }} 
                                                                  {{ last_name }} 
                                                          </span>
                                                      </a>
                                                {% endfor %}
                                            {% else %}
                                                <a href="{{ user_url }}">
                                                    <span class="badge rounded-pill bg-primary text-white fs-5 m-1 user">
                                                            {{ first_name }} 
                                                            {{ last_name }} 
                                                    </span>
                                                </a>
                                            {% endif %}    
                                          </div>
                                      </div>
                                  </div>
                                  <div class="row body-row">
                                      <div class="col">
                                          <a href="{{ message_url }}" class="text-decoration-none">
                                              <div class="py-1 px-3 text-truncate text-navy message-body">
                                                  {{ message_body }}
                                              </div>
                                          </a>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                      <div class="col-3">
                          <div class="container-fluid h-100 gx-1">
                              <div class="row h-50">
                                  <div class="col">
                                      <div class="container-fluid gy-0 py-2 h-100">
                                          <div class="row">
                                              <div class="col">
                                                  <div class="time-string text-center text-navy fs-6">
                                                      {{ datetime_list[0] }}
                                                  </div>
                                              </div>
                                          </div>
                                          <div class="row">
                                              <div class="col">
                                                  <div class="date-string text-center text-navy fs-6">
                                                      {{ datetime_list[1] }}
                                                  </div>
                                              </div>
                                          </div>
                                          <div class="row">
                                          </div>
                                      </div>
                                  </div>
                              </div>
                              <div class="row actions-row h-50 justify-content-center align-items-center">
                              <!-- TODO: fix link -->
                              {% set edit_url = url_for('messages.draft_edit', id_message=id_message) %}
                              {% set send_url = url_for('messages.send_message', id=id_message) %}
                              {% set forward_url = url_for('messages.forward_message', id=id_message) %}
                              {% set reply_url = url_for('messages.reply_to_message', id=id_message) %}
                              {% set withdraw_url = url_for('messages.withdraw_message', id=id_message) %}

                              {% if list_type == 'received' %}
                                  {% set delete_url = url_for('messages.delete_read_message', id=id_message) %}
                              {% elif list_type == 'draft' %}
                                  {% set delete_url = url_for('messages.delete_draft', id=id_message) %}
                              {% endif %}

                                  {% if list_type=='draft' %}
                                  <div class="col-2 py-0 edit-action">
                                      <a href="{{ edit_url }}" class="text-decoration-none text-primary">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
  <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
</svg>
                                      </a>
                                  </div>
                                  {% endif %}
                                  {% if list_type=='draft' %}
                                  <div class="col-2 send-action">
                                      <a href="{{ send_url }}" class="text-decoration-none text-primary">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
</svg>
                                      </a>
                                  </div>
                                  {% endif %}
                                  {% if list_type=='received' or list_type=='sent' %}
                                  <div class="col-2 forward-action">
                                      <a href="{{ forward_url }}" class="text-decoration-none text-primary">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-forward" viewBox="0 0 16 16">
  <path d="M9.502 5.513a.144.144 0 0 0-.202.134V6.65a.5.5 0 0 1-.5.5H2.5v2.9h6.3a.5.5 0 0 1 .5.5v1.003c0 .108.11.176.202.134l3.984-2.933a.51.51 0 0 1 .042-.028.147.147 0 0 0 0-.252.51.51 0 0 1-.042-.028L9.502 5.513zM8.3 5.647a1.144 1.144 0 0 1 1.767-.96l3.994 2.94a1.147 1.147 0 0 1 0 1.946l-3.994 2.94a1.144 1.144 0 0 1-1.767-.96v-.503H2a.5.5 0 0 1-.5-.5v-3.9a.5.5 0 0 1 .5-.5h6.3v-.503z"/>
</svg>
                                      </a>
                                  </div>
                                  {% endif %}
                                  {% if list_type=='received' %}
                                  <div class="col-2 reply-action">
                                      <a href="{{ reply_url }}" class="text-decoration-none text-primary">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-reply" viewBox="0 0 16 16">
  <path d="M6.598 5.013a.144.144 0 0 1 .202.134V6.3a.5.5 0 0 0 .5.5c.667 0 2.013.005 3.3.822.984.624 1.99 1.76 2.595 3.876-1.02-.983-2.185-1.516-3.205-1.799a8.74 8.74 0 0 0-1.921-.306 7.404 7.404 0 0 0-.798.008h-.013l-.005.001h-.001L7.3 9.9l-.05-.498a.5.5 0 0 0-.45.498v1.153c0 .108-.11.176-.202.134L2.614 8.254a.503.503 0 0 0-.042-.028.147.147 0 0 1 0-.252.499.499 0 0 0 .042-.028l3.984-2.933zM7.8 10.386c.068 0 .143.003.223.006.434.02 1.034.086 1.7.271 1.326.368 2.896 1.202 3.94 3.08a.5.5 0 0 0 .933-.305c-.464-3.71-1.886-5.662-3.46-6.66-1.245-.79-2.527-.942-3.336-.971v-.66a1.144 1.144 0 0 0-1.767-.96l-3.994 2.94a1.147 1.147 0 0 0 0 1.946l3.994 2.94a1.144 1.144 0 0 0 1.767-.96v-.667z"/>
</svg>
                                      </a>
                                  </div>
                                  {% endif %}
                                  {% if list_type=='sent' and withdraw == True and m.is_arrived == False %}
                                  <div class="col-2 withdraw-action">
                                      <a href="{{ withdraw_url }}" class="text-decoration-none text-success">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-box-arrow-down" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M3.5 10a.5.5 0 0 1-.5-.5v-8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 0 0 1h2A1.5 1.5 0 0 0 14 9.5v-8A1.5 1.5 0 0 0 12.5 0h-9A1.5 1.5 0 0 0 2 1.5v8A1.5 1.5 0 0 0 3.5 11h2a.5.5 0 0 0 0-1h-2z"/>
  <path fill-rule="evenodd" d="M7.646 15.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 14.293V5.5a.5.5 0 0 0-1 0v8.793l-2.146-2.147a.5.5 0 0 0-.708.708l3 3z"/>
</svg>
                                      </a>
                                  </div>
                                  {% endif %}
                                  {% if list_type=='received' or list_type=='draft' %}
                                  <div class="col-2 delete-action">
                                      <a href="{{ delete_url }}" class="text-decoration-none text-danger">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
  <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
</svg>
                                      </a>
                                  </div>
                                  {% endif %}
                              </div>
                          </div>
                      </div>
                  </div>
                 
              {% endfor %}
              </div>
          </div>
      </div>
    </div>

    </body>
</html>

